<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>Starlight AR</title>

  <!-- A-Frame & MindAR -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.css" />

  <style>
    body, html { margin:0; padding:0; overflow:hidden; font-family:sans-serif; }

    /* 彈幕 */
    #barrage-container {
      position:absolute; top:0; left:0; width:100%; height:60%;
      overflow:hidden; pointer-events:none; display:none;
      z-index:20;
    }
    .barrage {
      position:absolute;
      white-space:nowrap;
      font-size:20px; color:white;
      background:rgba(0,0,0,0.55);
      padding:8px 14px;
      border-radius:999px;
      display:flex; align-items:center; gap:12px;
      animation: moveLeft 8s linear forwards;
      pointer-events:auto;
      cursor:pointer;
    }
    .barrage img {
      height:80px; border-radius:6px;
    }
    @keyframes moveLeft {
      from { left:100%; }
      to { left:-100%; }
    }

    /* 留言 UI */
    #messageForm {
      position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
      background:rgba(255,255,255,0.95);
      padding:8px 12px; border-radius:12px;
      display:flex; align-items:center; gap:8px;
      width:90%; max-width:900px;
      z-index:999; display:none;
    }
    #messageInput {
      width:250px; height:40px;
      border-radius:5px;
      border:2px solid #0078ff;
      box-shadow: 4px 4px #0078ff;
      padding:5px 10px;
      font-size:15px; font-weight:600;
    }
    #cameraButton { width:40px; height:40px; background:#eee; border-radius:50%; display:flex; justify-content:center; align-items:center; cursor:pointer; }
    #cameraButton img { width:22px; height:22px; }
    #sendButton {
      background:#fbca1f;
      padding:0.6em 1.3em;
      font-size:18px; font-weight:900;
      border:3px solid black; border-radius:0.4em;
      cursor:pointer;
    }

    #imageInput { display:none; }
    #imagePreview { height:90px; display:none; border-radius:6px; }
  </style>
</head>

<body>

<a-scene mindar-image="imageTargetSrc: travel-target.mind; autoStart: true"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:true"
         embedded>
  <a-camera look-controls="enabled:false" cursor="rayOrigin:mouse"></a-camera>
  <a-entity mindar-image-target="targetIndex:0" id="checkpoint"></a-entity>
</a-scene>

<div id="barrage-container"></div>

<!-- 留言輸入欄 -->
<div id="messageForm">
  <input id="messageInput" placeholder="Write a message..." />
  <label for="imageInput" id="cameraButton">
    <img src="camera-fill-svgrepo-com.svg">
  </label>
  <input id="imageInput" type="file" accept="image/*">
  <img id="imagePreview">
  <button id="sendButton">Send</button>
</div>
<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
/* ===========================
   Supabase Config
=========================== */
const SUPABASE_URL = "https://bshseelavtsyhmryvrfm.supabase.co";
const SUPABASE_KEY = "YOUR-ANON-KEY-HERE"; // ← 換返你個（不要公開）
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===========================
   DOM Reference
=========================== */
const form = document.getElementById("messageForm");
const msgInput = document.getElementById("messageInput");
const imgInput = document.getElementById("imageInput");
const preview = document.getElementById("imagePreview");
const barrageBox = document.getElementById("barrage-container");
const sendBtn = document.getElementById("sendButton");

let messages = [];
let barrageTimer = null;

/* ===========================
   彈幕顯示
=========================== */
function showBarrage(m){
  const el = document.createElement("div");
  el.className = "barrage";
  el.style.top = Math.random()*50 + "%";
  el.dataset.id = m.id;

  if(m.photo_url){
    const img = document.createElement("img");
    img.src = m.photo_url;
    el.appendChild(img);
  }

  if(m.message){
    el.append(document.createTextNode(m.message));
  }

  // like
  const like = document.createElement("span");
  like.style.marginLeft = "10px";
  like.innerHTML = `❤️ ${m.likes ?? 0}`;
  el.appendChild(like);

  // dblclick like
  el.addEventListener("dblclick", async ()=>{
    let newLikes = (m.likes ?? 0) + 1;
    like.innerHTML = `❤️ ${newLikes}`;
    m.likes = newLikes;

    await supabaseClient.from("comments").update({ likes:newLikes }).eq("id", m.id);
  });

  barrageBox.appendChild(el);
  setTimeout(()=>el.remove(), 9000);
}

/* ===========================
   Interval 播放
=========================== */
function startBarrage(){
  if(barrageTimer) return;
  barrageBox.style.display = "block";

  let i = 0;
  barrageTimer = setInterval(()=>{
    if(messages.length > 0){
      showBarrage(messages[i]);
      i = (i+1) % messages.length;
    }
  }, 2500);
}
function stopBarrage(){
  clearInterval(barrageTimer);
  barrageTimer = null;
  barrageBox.innerHTML = "";
  barrageBox.style.display = "none";
}

/* ===========================
   Load Comments
=========================== */
async function loadMessages(){
  const { data } = await supabaseClient
    .from("comments")
    .select("*")
    .order("created_at");
  messages = data || [];
}

/* ===========================
   Realtime Subscription
=========================== */
supabaseClient
  .channel("comments-realtime")
  .on("postgres_changes", { event:"*", schema:"public", table:"comments" }, payload=>{
      loadMessages();
  })
  .subscribe();

/* ===========================
   Photo Preview
=========================== */
imgInput.addEventListener("change", ()=>{
  const f = imgInput.files[0];
  if(!f){
    preview.style.display="none";
    return;
  }
  const reader = new FileReader();
  reader.onload = e=>{
    preview.src = e.target.result;
    preview.style.display = "inline";
  };
  reader.readAsDataURL(f);
});

/* ===========================
   Upload Image to Supabase
=========================== */
async function uploadImage(){
  const file = imgInput.files[0];
  if(!file) return null;

  const fileName = `${Date.now()}-${file.name}`;
  const { data, error } = await supabaseClient.storage
      .from("photos")
      .upload(fileName, file);

  if(error) { console.error(error); return null; }

  const { data:publicURL } = supabaseClient.storage
      .from("photos")
      .getPublicUrl(fileName);

  return publicURL.publicUrl;
}

/* ===========================
   Send Message
=========================== */
sendBtn.addEventListener("click", async ()=>{
  const msg = msgInput.value.trim();
  if(!msg && !imgInput.files.length) return;

  let photoURL = await uploadImage();

  await supabaseClient.from("comments").insert({
    message: msg,
    photo_url: photoURL
  });

  msgInput.value = "";
  imgInput.value = "";
  preview.style.display = "none";
});

/* ===========================
   Marker Events
=========================== */
document.getElementById("checkpoint").addEventListener("targetFound", async ()=>{
  form.style.display = "flex";
  await loadMessages();
  startBarrage();
});

document.getElementById("checkpoint").addEventListener("targetLost", ()=>{
  form.style.display = "none";
  stopBarrage();
});
</script>

</body>
</html>
